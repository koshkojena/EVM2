.model small
.stack 100h

.data
    MAX_BUFFER_SIZE EQU 200                     ; ???????????? ?????? ??????
    buffer db MAX_BUFFER_SIZE dup(0)            ; ????? ??? ???????? 200 ????????
    msgInput db 'Vvedite stroku (maksimum 200 simvolov): $'
    msgOutput db 0Dh, 0Ah, 'Izmenennaya stroka: $'
    msgEnd db 0Dh, 0Ah, 'Konec vvoda.$'
    msgOverflow db 0Dh, 0Ah, 'Oshibka: perepleneniye bufera.$'
    length db 0                                  ; ????? ????????? ??????

.code
main proc
    ; ????????????? ?????????
    mov ax, @data
    mov ds, ax

    ; ????? ????????? ? ?????
    mov dx, offset msgInput
    mov ah, 09h
    int 21h

    ; ???? ?????? ?????????
    lea di, buffer + 2                          ; ????????? ?? ?????? ?????? (?????????? 2 ?????)
    mov byte ptr [buffer], MAX_BUFFER_SIZE      ; ???????????? ?????
    mov byte ptr [length], 0                     ; ???????? ????? ??????

input_loop:
    ; ?????? ???? ??????
    mov ah, 01h                                  ; ??????? ??? ????? ?????? ???????
    int 21h                                      ; ????? ??????????
    cmp al, 0Dh                                  ; ???????? ?? ?????? Enter (0Dh)
    je end_input                                  ; ???? Enter, ????????? ? ?????????? ?????
    cmp byte ptr [length], MAX_BUFFER_SIZE      ; ???????? ?????
    ja overflow_error                            ; ???? ?????????, ????????? ? ??????
    
    ; ?????? ??????? ? ?????????? ?????
    mov [di], al                                 ; ????????? ????????? ??????
    inc di                                        ; ??????? ? ?????????? ???????
    inc byte ptr [length]                         ; ??????????? ?????
    jmp input_loop                                ; ???????????? ? ?????

end_input:
    ; ????????? ?????? '$' ? ????? ?????? ??? ??????????? ??????
    mov byte ptr [di], '$'                       ; ????????? ?????? ???????? '$'

    ; ?????????? ????????? ?????? ?? ???????????
    lea si, buffer + 2                           ; ????????? ?? ?????? ????????? ?????? (?????????? 2 ?????)
    mov cl, [length]                             ; ????????? ????? ?????? ? CL

outer_loop:
    dec cl                                    ; ????????? ????? ?????? ?? 1
    jz end_sort                               ; ???? ????? ?????? 0, ??????????? ??????????
    mov di, si                                 ; ????????? ?? ????????? ??????
    mov bl, cl                                 ; ????????? ??????? ???????? cl ? bl ??? ??????????? ?????

inner_loop:
    mov al, [di]                               ; ????? ??????? ??????
    mov ah, [di + 1]                           ; ????? ????????? ??????
    cmp al, ah                                 ; ?????????? ??????? ?? ASCII-????
    jbe no_swap                                ; ???? ??????? ?????? ?????? ??? ????? ??????????, ?????????? ?????
    xchg al, ah                                ; ?????? ??????? ???????
    mov [di], al                               ; ?????????? ??????? ??????
    mov [di + 1], ah                           ; ?????????? ????????? ??????

no_swap:
    inc di                                      ; ????????? ? ?????????? ???????
    dec bl                                      ; ????????? ???????
    jnz inner_loop                              ; ???? ???? ??? ???????, ?????????? ?????????? ????

    jmp outer_loop                              ; ???????????? ? ???????? ?????

end_sort:
    ; ????????? ?????? '$' ? ????? ?????? ??? ??????????? ??????
    lea si, buffer + 2                          ; ?????????? ?????? ???? (???????????? ?????) ? ???? ?????
    mov al, [length]                            ; ????????? ????? ?????? ? AL
    xor ah, ah                                  ; ???????? AH (??????? ????) ????? ???????????
    add si, ax                                  ; ????????????? ????????? ?? ????? ??????
    mov byte ptr [si], '$'                      ; ????????? '$' ? ????? ??????

    ; ????????? ?????? ????? ??????
    mov ah, 02h
    mov dl, 0Ah                                 ; ??????? ??????
    int 21h

    ; ??????? ????????? "Izmenennaya stroka:"
    mov dx, offset msgOutput
    mov ah, 09h                                  ; ??????? ??? ?????? ??????
    int 21h

    ; ??????? ?????????? ?????? (????? ??????)
    lea dx, buffer + 2                           ; ????????? ?? ?????? (?????????? 2 ?????)
    mov ah, 09h                                  ; ??????? ??? ?????? ??????
    int 21h

    ; ????????? ?????? ????? ??????
    mov ah, 02h
    mov dl, 0Ah                                 ; ??????? ??????
    int 21h

    ; ?????????? ?????????
    mov dx, offset msgEnd
    mov ah, 09h                                  ; ??????? ??? ?????? ??????
    int 21h

    ; ?????????? ?????????
    mov ax, 4C00h
    int 21h

overflow_error:
    ; ??????? ????????? ?? ?????? ????????????
    mov dx, offset msgOverflow
    mov ah, 09h
    int 21h

    ; ?????????? ?????????
    mov ax, 4C00h
    int 21h

main endp
end main
